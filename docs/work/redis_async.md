# 一个关于redis的错误

## 现象

之前做了一个多服务器单点登录的东西，也就是说一个点登录，其他不同域名的网站也自动登录。退出亦然。

之前测试好好的，在部署美国服务器的时候出现了问题，在美国的登录中心通知中国的网站通知不了，但是中国通知美国服务是ok的。

## 检查日志

日志发现，美国服务器通知中国服务器登录的时候，中国服务器没有找到登录的`token`导致报错的

两方保证登录`token`是用一个中间的**redis**服务。通过日志记录的`token` 去**redis**查询，发现 `token` 是存在的. 

但是中国服务通知美国是**ok**. 这就很疑惑的.

## 排查 redis.

首先检查代码，以及在代码中加日志. 代码中返回就是没有找到 `token`. 排查代码后，也没有发现问题。

于是更换思路，在 `redis` 服务器中查看 `redis` 日志.

发现一个问题，当中国服务通知美国服务的时候，顺序是按照代码的逻辑来的， 但是美国服务器通知中国服务器的时候是乱的，会出现先 `get` 操作，再 `set` 操作。 这有点不科学.

## 测试

根据 `redis` 的日志，考虑是网络问题，也就是美国在向中间服务器写入 `token` 还没有完成的时候就，就调用了 `get`. 以前只是在国内服务器做测试，这个问题不明显，顺序还是能跟上。

所以做了一个测试，让美国服务器先写入 `token`, 这个操作**延迟10秒**后，再进行其他通知，然后发现通知成功。

也就是说中国服务器访问 `redis` 服务明显快很多，所以问题没有在中文服务暴露出来.

## 解决.

2点

1. 将 `redis` 的 **set** 操作写为同步操作，保证完成后再进行下一步。

2. 美国服务连 `redis` 太慢的问题，目前先通过代理增加速度。